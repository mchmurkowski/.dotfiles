#!/usr/bin/lua5.4
local launcher_command = "fuzzel"
local terminal_command = "alacritty"
local scripts_dir = (os.getenv("XDG_CONFIG_HOME") .. "/river/scripts")
local cursor_theme = "Hackneyed-24px"
local river_settings = {["background-color"] = "0x6d8196", ["border-width"] = "3", ["border-color-focused"] = "0x005e8b", ["border-color-unfocused"] = "0xc2bcb5", ["keyboard-layout"] = "-options 'ctrl:nocaps' 'pl'", ["set-repeat"] = "30 300", ["xcursor-theme"] = cursor_theme, ["focus-follows-cursor"] = "normal", ["set-cursor-warp"] = "on-focus-change", ["default-attach-mode"] = "bottom", ["default-layout"] = "rivertile"}
local rule_tags = {emacs = (1 << 0), term = (1 << 1), browser = (1 << 2), qgis = (1 << 7)}
local function rctl_spawn(command)
  return os.execute(("riverctl spawn " .. command))
end
local function rctl_map(mapping)
  local mode = mapping.mode
  local lhs = mapping.lhs
  local rhs = mapping.rhs
  return os.execute(("riverctl map " .. mode .. " " .. lhs .. " " .. rhs))
end
local function rctl_mouse_map(mapping)
  local mode = mapping.mode
  local lhs = mapping.lhs
  local rhs = mapping.rhs
  return os.execute(("riverctl map-pointer " .. mode .. " " .. lhs .. " " .. rhs))
end
local function rctl_set(setting, value)
  return os.execute(("riverctl " .. setting .. " " .. value))
end
local function rconf()
  rctl_spawn("'dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=river'")
  rctl_spawn("'systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=river'")
  rctl_map({mode = "normal", lhs = "Super Space", rhs = ("spawn " .. launcher_command)})
  rctl_map({mode = "normal", lhs = "Super Return", rhs = ("spawn " .. terminal_command)})
  rctl_map({mode = "normal", lhs = "Super+Shift Return", rhs = "spawn 'emacsclient -c -e \"(eshell)\"'"})
  rctl_map({mode = "normal", lhs = "Super T", rhs = ("spawn " .. scripts_dir .. "/time_teller.sh")})
  rctl_map({mode = "normal", lhs = "Super Escape", rhs = "spawn 'makoctl dismiss'"})
  rctl_map({mode = "normal", lhs = "Super Q", rhs = "close"})
  rctl_map({mode = "normal", lhs = "Super+Shift Q", rhs = ("spawn " .. scripts_dir .. "/power_menu.sh")})
  rctl_map({mode = "normal", lhs = "Super+Shift E", rhs = "exit"})
  rctl_map({mode = "normal", lhs = "Alt+Control L", rhs = ("spawn " .. "'waylock -ignore-empty-password -init-color 0x2F4F4F -input-color 0xA0E8AF -fail-color 0xFFCF56'")})
  rctl_map({mode = "normal", lhs = "Super O", rhs = "zoom"})
  rctl_map({mode = "normal", lhs = "Super J", rhs = "focus-view next"})
  rctl_map({mode = "normal", lhs = "Super K", rhs = "focus-view previous"})
  rctl_map({mode = "normal", lhs = "Super+Shift J", rhs = "swap next"})
  rctl_map({mode = "normal", lhs = "Super+Shift K", rhs = "swap previous"})
  rctl_map({mode = "normal", lhs = "Super H", rhs = "send-layout-cmd rivertile 'main-ratio -0.05'"})
  rctl_map({mode = "normal", lhs = "Super L", rhs = "send-layout-cmd rivertile 'main-ratio +0.05'"})
  rctl_map({mode = "normal", lhs = "Super+Shift H", rhs = "send-layout-cmd rivertile 'main-count +1'"})
  rctl_map({mode = "normal", lhs = "Super+Shift J", rhs = "send-layout-cmd rivertile 'main-count -1'"})
  rctl_map({mode = "normal", lhs = "Super F", rhs = "toggle-float"})
  rctl_map({mode = "normal", lhs = "Super+Shift F", rhs = "toggle-fullscreen"})
  do
    local directions = {H = "left", J = "down", K = "up", L = "right"}
    for key, direction in pairs(directions) do
      rctl_map({mode = "normal", lhs = ("Super+Alt " .. key), rhs = ("move " .. direction .. " 100")})
    end
    for key, direction in pairs(directions) do
      rctl_map({mode = "normal", lhs = ("Super+Alt+Control " .. key), rhs = ("snap " .. direction)})
    end
  end
  for key, direction in pairs({H = {"horizontal", "-100"}, J = {"vertical", "100"}, K = {"vertical", "-100"}, L = {"horizontal", "100"}}) do
    rctl_map({mode = "normal", lhs = ("Super+Alt+Shift " .. key), rhs = ("resize " .. direction[1] .. " " .. direction[2])})
  end
  do
    local directions = {Up = "top", Right = "right", Down = "bottom", Left = "left"}
    for key, direction in pairs(directions) do
      rctl_map({mode = "normal", lhs = ("Super " .. key), rhs = ("send-layout-cmd rivertile 'main-location " .. direction .. "'")})
    end
  end
  rctl_mouse_map({mode = "normal", lhs = "Super BTN_LEFT", rhs = "move-view"})
  rctl_mouse_map({mode = "normal", lhs = "Super BTN_RIGHT", rhs = "resize-view"})
  rctl_mouse_map({mode = "normal", lhs = "Super BTN_MIDDLE", rhs = "toggle-float"})
  for i = 1, 9 do
    local tags = (1 << (i - 1))
    rctl_map({mode = "normal", lhs = ("Super " .. i), rhs = ("set-focused-tags " .. tags)})
    rctl_map({mode = "normal", lhs = ("Super+Control " .. i), rhs = ("set-view-tags " .. tags)})
    rctl_map({mode = "normal", lhs = ("Super+Shift " .. i), rhs = ("toggle-focused-tags " .. tags)})
    rctl_map({mode = "normal", lhs = ("Super+Shift+Control " .. i), rhs = ("toggle-view-tags " .. tags)})
  end
  local all_tags = ((1 << 32) - 1)
  rctl_map({mode = "normal", lhs = "Super 0", rhs = ("set-focused-tags " .. all_tags)})
  rctl_map({mode = "normal", lhs = "Super+Shift 0", rhs = ("set-view-tags " .. all_tags)})
  for setting, value in pairs(river_settings) do
    rctl_set(setting, value)
  end
  rctl_set("rule-add", "ssd")
  rctl_set("rule-add", "-app-id 'QGIS3' csd")
  rctl_set("rule-add", ("-app-id 'emacs' tags " .. rule_tags.emacs))
  rctl_set("rule-add", ("-app-id 'Alacritty' tags " .. rule_tags.term))
  rctl_set("rule-add", ("-app-id 'firefox' tags " .. rule_tags.browser))
  rctl_set("rule-add", ("-app-id 'QGIS3' tags " .. rule_tags.qgis))
  rctl_spawn("emacs")
  rctl_spawn(terminal_command)
  rctl_spawn("firefox")
  return os.execute("rivertile -view-padding 4 -outer-padding 4 -main-ratio 0.5 &")
end
return rconf()
