#!/usr/bin/lua5.4
local colors = {background = "0x6d8196", border = "0x9f9f9f", ["border-focused"] = "0x005e8b", ["border-unfocused"] = "0xc2bcbb5", ["border-urgent"] = "0xa60000", ["sl-init"] = "0x2f4f4f", ["sl-input"] = "0xa0e8af", ["sl-fail"] = "0xffcf56"}
local scripts_dir = (os.getenv("XDG_CONFIG_HOME") .. "/river/scripts")
local applications = {launcher = "fuzzel", editor = "emacs", term = "alacritty", browser = "firefox", ["screen-locker"] = string.format("'waylock -ignore-empty-password -init-color %s -input-color %s -fail-color %s'", colors["sl-init"], colors["sl-input"], colors["sl-fail"]), ["power-menu"] = (scripts_dir .. "/power_menu.sh"), ["time-teller"] = (scripts_dir .. "/time_teller.sh")}
local function rctl_set(setting, value)
  return os.execute(string.format("riverctl %s %s", setting, value))
end
local function rctl_spawn(command)
  return os.execute(string.format("riverctl spawn %s", command))
end
local function rctl_kbd_map(binding)
  local lhs = binding.lhs
  local rhs = binding.rhs
  local _3fmode = binding.mode
  return os.execute(string.format("riverctl map %s %s %s", (_3fmode or "normal"), lhs, rhs))
end
local function rctl_ptr_map(binding)
  local lhs = binding.lhs
  local rhs = binding.rhs
  local _3fmode = binding.mode
  return os.execute(string.format("riverctl map-pointer %s %s %s", (_3fmode or "normal"), lhs, rhs))
end
local function rctl_add_rule(rule)
  return os.execute(string.format("riverctl rule-add %s", table.concat(rule, " ")))
end
local function rconf()
  do
    local interop = {"'dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=river'", "'systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=river'"}
    for _, command in ipairs(interop) do
      rctl_spawn(command)
    end
  end
  do
    local settings = {["default-attach-mode"] = "bottom", ["default-layout"] = "rivertile", ["background-color"] = colors.background, ["border-color"] = colors.border, ["border-color-focused"] = colors["border-focused"], ["border-color-unfocused"] = colors["border-unfocused"], ["border-color-urgent"] = colors["border-urgent"], ["border-width"] = "3", ["focus-follows-cursor"] = "normal", ["hide-cursor timeout"] = "3000", ["hide-cursor when-typing"] = "enabled", ["keyboard-layout"] = "-options 'ctrl:nocaps' 'pl'", ["set-cursor-warp"] = "on-focus-change", ["set-repeat"] = "30 300", ["xcursor-theme"] = "Hackneyed-24px"}
    for setting, value in pairs(settings) do
      rctl_set(setting, value)
    end
    rctl_spawn(string.format("'gsettings set org.gnome.desktop.interface cursor-theme %s'", settings["xcursor-theme"]))
  end
  do
    local bindings = {{lhs = "Super Space", rhs = ("spawn " .. applications.launcher)}, {lhs = "Super Return", rhs = ("spawn " .. applications.term)}, {lhs = "Super+Shift Return", rhs = ("spawn " .. applications.editor)}, {lhs = "Alt+Control L", rhs = ("spawn " .. applications["screen-locker"])}, {lhs = "Super+Shift Q", rhs = ("spawn " .. applications["power-menu"])}, {lhs = "Super T", rhs = ("spawn " .. applications["time-teller"])}, {lhs = "Super Esc", rhs = "spawn 'makoctl dissmiss'"}, {lhs = "Super Q", rhs = "close"}, {lhs = "Super+Shift E", rhs = "exit"}, {lhs = "Super O", rhs = "zoom"}, {lhs = "Super F", rhs = "toggle-float"}, {lhs = "Super+Shift F", rhs = "toggle-fullscreen"}, {lhs = "Super J", rhs = "focus-view next"}, {lhs = "Super K", rhs = "focus-view previous"}, {lhs = "Super+Shift J", rhs = "swap next"}, {lhs = "Super+Shift K", rhs = "swap previous"}, {lhs = "Super H", rhs = "send-layout-cmd rivertile 'main-ratio -0.05'"}, {lhs = "Super L", rhs = "send-layout-cmd rivertile 'main-ratio +0.05'"}, {lhs = "Super+Shift H", rhs = "send-layout-cmd rivertile 'main-count +1'"}, {lhs = "Super+Shift L", rhs = "send-layout-cmd rivertile 'main-count -1'"}}
    for _, binding in ipairs(bindings) do
      rctl_kbd_map(binding)
    end
  end
  do
    local directions = {H = {"left", "horizontal", "-100"}, J = {"down", "vertical", "100"}, K = {"up", "vertical", "-100"}, L = {"right", "horizontal", "100"}}
    for key, _1_ in pairs(directions) do
      local direction = _1_[1]
      local plane = _1_[2]
      local value = _1_[3]
      local bindings = {{lhs = ("Super+Alt " .. key), rhs = string.format("move %s 100", direction)}, {lhs = ("Super+Alt+Control " .. key), rhs = ("snap " .. direction)}, {lhs = ("Super+Alt+Shift " .. key), rhs = string.format("resize %s %s", plane, value)}}
      for _, binding in ipairs(bindings) do
        rctl_kbd_map(binding)
      end
    end
  end
  do
    local directions = {Up = "top", Right = "right", Down = "bottom", Left = "left"}
    for key, direction in pairs(directions) do
      local bindings = {{lhs = ("Super+Alt+Shift " .. key), rhs = string.format("send-layout-cmd rivertile 'main-location %s'", direction)}}
      for _, binding in ipairs(bindings) do
        rctl_kbd_map(binding)
      end
    end
  end
  do
    local bindings = {{lhs = "Super BTN_LEFT", rhs = "move-view"}, {lhs = "Super BTN_RIGHT", rhs = "resize-view"}, {lhs = "Super BTN_MIDDLE", rhs = "toggle-float"}}
    for _, binding in ipairs(bindings) do
      rctl_ptr_map(binding)
    end
  end
  for i = 1, 9 do
    local tag = (1 << (i - 1))
    local bindings = {{lhs = ("Super " .. i), rhs = ("set-focused-tags " .. tag)}, {lhs = ("Super+Control " .. i), rhs = ("set-view-tags " .. tag)}, {lhs = ("Super+Shift " .. i), rhs = ("toggle-focused-tags " .. tag)}, {lhs = ("Super+Shift+Control " .. i), rhs = ("toggle-view-tags " .. tag)}}
    for _, binding in ipairs(bindings) do
      rctl_kbd_map(binding)
    end
  end
  do
    local tags = ((1 << 32) - 1)
    local bindings = {{lhs = "Super 0", rhs = ("set-focused-tags " .. tags)}, {lhs = "Super+Shift 0", rhs = ("set-view-tags " .. tags)}}
    for _, binding in ipairs(bindings) do
      rctl_kbd_map(binding)
    end
  end
  do
    local named_tags = {emacs = (1 << 0), term = (1 << 1), web = (1 << 2), qgis = (1 << 7)}
    local rules = {["default-to-ssd"] = {"ssd"}, ["qgis-use-csd"] = {"-app-id 'QGIS 3'", "csd"}, ["assign-emacs-tag"] = {"-app-id 'emacs'", ("tags " .. named_tags.emacs)}, ["assign-term-tag"] = {"-app-id 'Alacritty'", ("tags " .. named_tags.term)}, ["assign-web-tag"] = {"-app-id 'firefox'", ("tags " .. named_tags.web)}, ["assign-qgis-tag"] = {"-app-id 'QGIS3'", ("tags " .. named_tags.qgis)}}
    for _, rule in pairs(rules) do
      rctl_add_rule(rule)
    end
  end
  do
    local autostart_apps = {applications.editor, applications.term, applications.browser}
    for _, app in ipairs(autostart_apps) do
      rctl_spawn(app)
    end
  end
  return os.execute("rivertile -view-padding 4 -outer-padding 4 -main-ratio 0.5 &")
end
return rconf()
